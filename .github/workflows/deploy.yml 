name: Deploy Thesis Generator to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual triggering

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch all history for proper versioning

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Verify Flutter installation
      run: |
        flutter --version
        flutter doctor -v

    - name: Get Flutter dependencies
      run: flutter pub get

    - name: Analyze Flutter code
      run: flutter analyze --fatal-infos

    - name: Run Flutter tests
      run: flutter test
      continue-on-error: true # Don't fail deployment if tests fail

    - name: Build Flutter web app
      run: |
        flutter build web --release \
          --web-renderer html \
          --base-href /thesis-web/ \
          --dart-define=FLUTTER_WEB_USE_SKIA=false \
          --dart-define=FLUTTER_WEB_AUTO_DETECT=false

    - name: Prepare web files for deployment
      run: |
        echo "üìÅ Preparing deployment files..."
        
        # Create necessary directories
        mkdir -p build/web/css
        mkdir -p build/web/js
        mkdir -p build/web/assets
        
        # Copy landing page HTML files
        echo "üìÑ Copying HTML files..."
        cp web/index.html build/web/ || echo "‚ö†Ô∏è index.html not found"
        cp web/privacy.html build/web/ || echo "‚ö†Ô∏è privacy.html not found"
        cp web/terms.html build/web/ || echo "‚ö†Ô∏è terms.html not found"
        cp web/cookies.html build/web/ || echo "‚ö†Ô∏è cookies.html not found"
        cp web/academic-integrity.html build/web/ || echo "‚ö†Ô∏è academic-integrity.html not found"
        cp web/contact.html build/web/ || echo "‚ö†Ô∏è contact.html not found"
        
        # Copy CSS files
        echo "üé® Copying CSS files..."
        cp web/css/landing.css build/web/css/ || echo "‚ö†Ô∏è landing.css not found"
        cp web/css/*.css build/web/css/ 2>/dev/null || echo "‚ÑπÔ∏è No additional CSS files found"
        
        # Copy JavaScript files
        echo "üìú Copying JavaScript files..."
        cp web/js/landing.js build/web/js/ || echo "‚ö†Ô∏è landing.js not found"
        cp web/js/cookies.js build/web/js/ || echo "‚ö†Ô∏è cookies.js not found"
        cp web/js/*.js build/web/js/ 2>/dev/null || echo "‚ÑπÔ∏è No additional JS files found"
        
        # Copy additional assets if they exist
        echo "üñºÔ∏è Copying assets..."
        if [ -d "web/assets" ]; then
          cp -r web/assets/* build/web/assets/ || echo "‚ö†Ô∏è Failed to copy assets"
        fi
        
        # Copy favicon and other root files
        cp web/favicon.png build/web/ 2>/dev/null || echo "‚ÑπÔ∏è favicon.png not found"
        cp web/favicon.ico build/web/ 2>/dev/null || echo "‚ÑπÔ∏è favicon.ico not found"
        cp web/manifest.json build/web/ 2>/dev/null || echo "‚ÑπÔ∏è manifest.json not found"
        
        # Rename Flutter's index.html to app.html (Flutter app entry point)
        if [ -f "build/web/index.html" ]; then
          mv build/web/index.html build/web/app.html
          echo "‚úÖ Renamed Flutter index.html to app.html"
        else
          echo "‚ùå Flutter index.html not found!"
          exit 1
        fi

    - name: Create SEO and meta files
      run: |
        echo "üîç Creating SEO files..."
        
        # Create sitemap.xml
        cat > build/web/sitemap.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
          <url>
            <loc>https://kaynelapps.github.io/thesis-web/</loc>
            <lastmod>$(date +%Y-%m-%d)</lastmod>
            <changefreq>weekly</changefreq>
            <priority>1.0</priority>
          </url>
          <url>
            <loc>https://kaynelapps.github.io/thesis-web/app.html</loc>
            <lastmod>$(date +%Y-%m-%d)</lastmod>
            <changefreq>monthly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://kaynelapps.github.io/thesis-web/privacy.html</loc>
            <lastmod>$(date +%Y-%m-%d)</lastmod>
            <changefreq>monthly</changefreq>
            <priority>0.5</priority>
          </url>
          <url>
            <loc>https://kaynelapps.github.io/thesis-web/terms.html</loc>
            <lastmod>$(date +%Y-%m-%d)</lastmod>
            <changefreq>monthly</changefreq>
            <priority>0.5</priority>
          </url>
          <url>
            <loc>https://kaynelapps.github.io/thesis-web/cookies.html</loc>
            <lastmod>$(date +%Y-%m-%d)</lastmod>
            <changefreq>monthly</changefreq>
            <priority>0.5</priority>
          </url>
          <url>
            <loc>https://kaynelapps.github.io/thesis-web/academic-integrity.html</loc>
            <lastmod>$(date +%Y-%m-%d)</lastmod>
            <changefreq>monthly</changefreq>
            <priority>0.6</priority>
          </url>
          <url>
            <loc>https://kaynelapps.github.io/thesis-web/contact.html</loc>
            <lastmod>$(date +%Y-%m-%d)</lastmod>
            <changefreq>monthly</changefreq>
            <priority>0.7</priority>
          </url>
        </urlset>
        EOF
        
        # Create robots.txt
        cat > build/web/robots.txt << 'EOF'
        User-agent: *
        Allow: /
        
        # Disallow sensitive areas
        Disallow: /app.html/admin
        Disallow: /app.html/api
        
        # Sitemap location
        Sitemap: https://kaynelapps.github.io/thesis-web/sitemap.xml
        EOF
        
        # Create .nojekyll file to prevent GitHub Pages from processing files
        touch build/web/.nojekyll
        
    - name: Create 404 page
      run: |
        cat > build/web/404.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Page Not Found - Thesis Generator</title>
            <link rel="stylesheet" href="css/landing.css">
            <style>
                .error-page {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    text-align: center;
                    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                    color: white;
                    padding: 2rem;
                }
                .error-code { font-size: 6rem; color: #9D4EDD; font-weight: bold; }
                .error-message { font-size: 1.5rem; margin: 1rem 0; }
                .error-description { color: rgba(255,255,255,0.7); margin-bottom: 2rem; }
                .home-button {
                    background: linear-gradient(135deg, #9D4EDD, #FF48B0);
                    color: white;
                    padding: 1rem 2rem;
                    border: none;
                    border-radius: 8px;
                    text-decoration: none;
                    font-weight: bold;
                    transition: transform 0.3s ease;
                }
                .home-button:hover { transform: translateY(-2px); }
            </style>
        </head>
        <body>
            <div class="error-page">
                <div class="error-code">404</div>
                <div class="error-message">Page Not Found</div>
                <div class="error-description">The page you're looking for doesn't exist.</div>
                <a href="/" class="home-button">‚Üê Back to Home</a>
            </div>
        </body>
        </html>
        EOF

    - name: Validate build output
      run: |
        echo "üîç Validating build output..."
        
        # Check if critical files exist
        if [ ! -f "build/web/app.html" ]; then
          echo "‚ùå app.html (Flutter app) not found!"
          exit 1
        fi
        
        if [ ! -f "build/web/index.html" ]; then
          echo "‚ùå index.html (landing page) not found!"
          exit 1
        fi
        
        # List all files for debugging
        echo "üìã Files in build/web:"
        find build/web -type f | head -20
        
        # Check file sizes
        echo "üìä Build statistics:"
        du -sh build/web
        echo "Total files: $(find build/web -type f | wc -l)"

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './build/web'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Post-deployment verification
      run: |
        echo "üéâ Deployment completed!"
        echo "üåê Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "üì± Flutter App: ${{ steps.deployment.outputs.page_url }}app.html"
        echo "üìÑ Landing Page: ${{ steps.deployment.outputs.page_url }}"
        
        # Optional: Ping the site to warm it up
        curl -s -o /dev/null -w "%{http_code}" "${{ steps.deployment.outputs.page_url }}" || echo "Site not immediately available"

  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "‚úÖ Deployment successful!"
          echo "üöÄ Thesis Generator is now live at: https://kaynelapps.github.io/thesis-web/"
        else
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for details."
        fi
