<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Create your thesis with AI - Professional academic writing assistant">
  <meta name="keywords" content="thesis generator, AI writing, academic writing, research paper">
  <meta name="author" content="Thesis Generator">
  
  <!-- Mobile Web App -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Thesis Generator">
  
  <!-- Theme Colors -->
  <meta name="theme-color" content="#9D4EDD">
  <meta name="msapplication-navbutton-color" content="#9D4EDD">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" href="favicon.png"/>
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="manifest" href="manifest.json">
  
  <title>Create Your Thesis - AI-Powered Academic Writing</title>

  <!-- Preconnect for performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com">

  <style>
    /* ==============================================
       LOADING SCREEN STYLES
       ============================================== */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }

    .loading.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .loading-content {
      text-align: center;
      max-width: 400px;
      padding: 2rem;
    }

    .app-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(45deg, #9D4EDD, #FF48B0);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2rem;
      font-size: 2rem;
      box-shadow: 0 8px 32px rgba(157, 78, 221, 0.3);
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #FF48B0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }

    .loading-subtext {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 2rem;
      line-height: 1.4;
    }

    .loading-progress {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #FF48B0, #9D4EDD);
      border-radius: 2px;
      width: 0%;
      animation: progress 3s ease-in-out;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 60%; }
      100% { width: 100%; }
    }

    .loading-tips {
      font-size: 0.9rem;
      opacity: 0.7;
      font-style: italic;
    }

    /* ==============================================
       ERROR STATE STYLES
       ============================================== */

    .error-content {
      text-align: center;
      max-width: 500px;
      padding: 2rem;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.8;
    }

    .error-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #FF6B6B;
    }

    .error-message {
      font-size: 1.1rem;
      margin-bottom: 2rem;
      line-height: 1.5;
      opacity: 0.9;
    }

    .error-suggestions {
      text-align: left;
      margin: 1.5rem 0;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .error-suggestions h3 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .error-suggestions ul {
      list-style: none;
      padding: 0;
    }

    .error-suggestions li {
      margin-bottom: 0.8rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .error-suggestions li::before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: #FF48B0;
      font-weight: bold;
    }

    .error-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 2rem;
    }

    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      min-width: 120px;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(45deg, #9D4EDD, #FF48B0);
      color: white;
      box-shadow: 0 4px 15px rgba(157, 78, 221, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(157, 78, 221, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    /* ==============================================
       RESPONSIVE DESIGN
       ============================================== */

    @media (max-width: 768px) {
      .loading-content,
      .error-content {
        padding: 1rem;
        max-width: 90%;
      }

      .app-logo {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .loading-text {
        font-size: 1.2rem;
      }

      .loading-subtext {
        font-size: 0.9rem;
      }

      .error-title {
        font-size: 1.5rem;
      }

      .error-message {
        font-size: 1rem;
      }

      .error-actions {
        flex-direction: column;
        align-items: center;
      }

      .btn {
        width: 100%;
        max-width: 200px;
      }
    }

    @media (max-width: 480px) {
      .loading-content,
      .error-content {
        padding: 0.5rem;
      }

      .app-logo {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }

      .loading-text {
        font-size: 1.1rem;
      }

      .error-suggestions {
        padding: 1rem;
      }
    }

    /* ==============================================
       ACCESSIBILITY IMPROVEMENTS
       ============================================== */

    @media (prefers-reduced-motion: reduce) {
      .spinner {
        animation: none;
      }
      
      .loading-progress-bar {
        animation: none;
        width: 100%;
      }
      
      .btn {
        transition: none;
      }
    }

    @media (prefers-color-scheme: light) {
      .loading {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
    }

    /* ==============================================
       FLUTTER APP CONTAINER
       ============================================== */

    #flutter-app {
      width: 100%;
      height: 100vh;
      display: none;
    }

    #flutter-app.loaded {
      display: block;
    }

    /* ==============================================
       UTILITY CLASSES
       ============================================== */

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ==============================================
       CRITICAL CSS FOR FLUTTER
       ============================================== */

    /* Ensure Flutter app takes full viewport */
    flt-glass-pane {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
    }

    /* Hide Flutter loading indicator since we have our own */
    flt-glass-pane * {
      pointer-events: auto !important;
    }

    /* Optimize for mobile */
    @media (max-width: 768px) {
      body {
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
    }

    /* Prevent zoom on input focus (iOS) */
    @media screen and (max-width: 768px) {
      input[type="text"],
      input[type="email"],
      input[type="password"],
      textarea,
      select {
        font-size: 16px !important;
      }
    }

    /* Loading animation optimizations */
    @media (prefers-reduced-motion: reduce) {
      .spinner,
      .loading-progress-bar,
      .fade-in {
        animation: none !important;
        transition: none !important;
      }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .loading {
        background: #000000;
        color: #ffffff;
      }
      
      .btn-primary {
        background: #ffffff;
        color: #000000;
        border: 2px solid #ffffff;
      }
    }

    /* Print styles */
    @media print {
      .loading,
      .error-content {
        display: none !important;
      }
      
      body::after {
        content: "This is a web application and cannot be printed. Please visit the website to use Thesis Generator.";
        display: block;
        text-align: center;
        padding: 2rem;
        font-size: 1.2rem;
      }
    }
  </style>

  <!-- Firebase Configuration - UPDATED WITH CORRECT PROJECT -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbErRqwrcX6-ogwmnmr98E3Q4H8KP4w9Q",
      authDomain: "thesis-generator-web.firebaseapp.com",
      projectId: "thesis-generator-web",
      storageBucket: "thesis-generator-web.firebasestorage.app",
      messagingSenderId: "1098826060423",
      appId: "1:1098826060423:web:7ee70dc121234297f05e22",
      measurementId: "G-BY0DNNV0K3"
    };

    // Global error handler
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
      if (typeof gtag !== 'undefined') {
        gtag('event', 'exception', {
          'description': e.error?.toString() || 'Unknown error',
          'fatal': false
        });
      }
    });

    // Performance monitoring
    window.addEventListener('load', function() {
      if ('performance' in window) {
        const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
        console.log('App load time:', loadTime + 'ms');
        
        if (typeof gtag !== 'undefined') {
          gtag('event', 'timing_complete', {
            'name': 'app_load',
            'value': loadTime
          });
        }
      }
    });
  </script>

  <!-- Firebase SDK -->
  <script type="module">
    try {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
      const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
      const { getAnalytics } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js');

      const app = initializeApp(firebaseConfig);
      window.fbApp = app;
      
      // Initialize services
      const db = getFirestore(app);
      const auth = getAuth(app);
      
      // Initialize analytics if supported
      if (typeof gtag !== 'undefined') {
        const analytics = getAnalytics(app);
        window.fbAnalytics = analytics;
      }
      
      console.log('‚úÖ Firebase initialized successfully');
    } catch (error) {
      console.error('‚ùå Firebase initialization failed:', error);
      // App can still work without Firebase
    }
  </script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BY0DNNV0K3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BY0DNNV0K3');
  </script>
</head>

<body>
  <!-- Screen Reader Announcement -->
  <div class="sr-only" aria-live="polite" id="sr-status">
    Loading Thesis Generator application...
  </div>

  <!-- Loading Screen -->
  <div class="loading" id="loading-screen" role="status" aria-label="Loading application">
    <div class="loading-content">
      <div class="app-logo" aria-hidden="true">üéì</div>
      
      <div class="spinner" aria-hidden="true"></div>
      
      <div class="loading-text">Loading Thesis Generator</div>
      <div class="loading-subtext">Preparing your AI writing assistant...</div>
      
      <div class="loading-progress" aria-hidden="true">
        <div class="loading-progress-bar"></div>
      </div>
      
      <div class="loading-tips" id="loading-tip">
        üí° Tip: Use your own API key for faster generation
      </div>
    </div>
  </div>

  <!-- Flutter App Container -->
  <div id="flutter-app"></div>

  <!-- Flutter Engine -->
  <script src="flutter.js" defer></script>
  
  <script>
    // ==============================================
    // LOADING TIPS ROTATION
    // ==============================================
    
    const loadingTips = [
      "üí° Tip: Use your own API key for faster generation",
      "üìö Tip: Choose the right citation format (APA, MLA, Chicago)",
      "‚úèÔ∏è Tip: All generated content is fully editable",
      "üéØ Tip: Be specific with your thesis topic for better results",
      "‚ö° Tip: Generate chapters one by one for better quality",
      "üîç Tip: Review and customize the AI-generated content",
      "üìñ Tip: Use academic writing style for formal papers"
    ];
    
    let tipIndex = 0;
    const tipElement = document.getElementById('loading-tip');
    
    function rotateTips() {
      if (tipElement) {
        tipElement.style.opacity = '0';
        setTimeout(() => {
          tipIndex = (tipIndex + 1) % loadingTips.length;
          tipElement.textContent = loadingTips[tipIndex];
          tipElement.style.opacity = '0.7';
        }, 300);
      }
    }
    
    // Rotate tips every 2 seconds
    const tipInterval = setInterval(rotateTips, 2000);

    // ==============================================
    // FLUTTER APP INITIALIZATION
    // ==============================================
    
    window.addEventListener('load', async function() {
      const loadingScreen = document.getElementById('loading-screen');
      const flutterApp = document.getElementById('flutter-app');
      const srStatus = document.getElementById('sr-status');
      
      // Update screen reader
      if (srStatus) {
        srStatus.textContent = 'Loading Flutter application components...';
      }

      // Configure Flutter
      window._flutter = {
        loader: {
          serviceWorker: {
            serviceWorkerVersion: null,
            serviceWorkerUrl: null
          }
        }
      };

      // Create script loading promise
      const scriptLoaderPromise = new Promise((resolve, reject) => {
        const scriptElement = document.createElement('script');
        scriptElement.src = 'main.dart.js';
        scriptElement.type = 'application/javascript';
        scriptElement.async = true;
        
        // Success handler
        scriptElement.addEventListener('load', () => {
          console.log('‚úÖ Flutter app loaded successfully');
          resolve();
        });
        
        // Error handler
        scriptElement.addEventListener('error', (error) => {
          console.error('‚ùå Failed to load Flutter app:', error);
          reject(new Error('Failed to load Flutter application'));
        });
        
        // Add to DOM
        document.body.appendChild(scriptElement);
      });

      try {
        // Wait for Flutter to load
        await scriptLoaderPromise;
        
        // Clear tip rotation
        clearInterval(tipInterval);
        
        // Update screen reader
        if (srStatus) {
          srStatus.textContent = 'Thesis Generator loaded successfully. You can now create your thesis.';
        }
        
        // Hide loading screen with animation
        setTimeout(() => {
          loadingScreen.classList.add('fade-out');
          flutterApp.classList.add('loaded');
          
          // Remove loading screen after animation
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 800);
        
        // Track successful load
        if (typeof gtag !== 'undefined') {
          gtag('event', 'app_loaded', {
            'event_category': 'Flutter App',
            'event_label': 'Success'
          });
        }
        
      } catch (error) {
        console.error('Flutter loading error:', error);
        showErrorScreen(error);
        
        // Track loading error
        if (typeof gtag !== 'undefined') {
          gtag('event', 'app_load_error', {
            'event_category': 'Flutter App',
            'event_label': error.message || 'Unknown error'
          });
        }
      }
    });

    // ==============================================
    // ERROR HANDLING
    // ==============================================
    
    function showErrorScreen(error) {
      const loadingScreen = document.getElementById('loading-screen');
      const srStatus = document.getElementById('sr-status');
      
      // Clear tip rotation
      clearInterval(tipInterval);
      
      // Update screen reader
      if (srStatus) {
        srStatus.textContent = 'Error loading application. Please try refreshing the page.';
      }
      
      // Show error content
      loadingScreen.innerHTML = `
        <div class="error-content fade-in">
          <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
          <h1 class="error-title">Unable to Load Thesis Generator</h1>
          <p class="error-message">
            We're having trouble loading the application. This might be due to a network issue or browser compatibility.
          </p>
          
          <div class="error-suggestions">
            <h3>Try these solutions:</h3>
            <ul>
              <li>Refresh the page and try again</li>
              <li>Check your internet connection</li>
              <li>Clear your browser cache and cookies</li>
              <li>Try using a different browser (Chrome, Firefox, Safari)</li>
              <li>Disable browser extensions temporarily</li>
              <li>Make sure JavaScript is enabled</li>
            </ul>
          </div>
          
          <div class="error-actions">
            <button onclick="window.location.reload()" class="btn btn-primary">
              <span>üîÑ</span>
              Try Again
            </button>
            <a href="index.html" class="btn btn-secondary">
              <span>‚Üê</span>
              Back to Home
            </a>
            <button onclick="runDiagnostics()" class="btn btn-secondary">
              <span>üîß</span>
              Run Diagnostics
            </button>
          </div>
          
          <details style="margin-top: 2rem; opacity: 0.7;">
            <summary style="cursor: pointer; margin-bottom: 1rem;">Technical Details</summary>
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem; text-align: left;">
              <strong>Error:</strong> ${error?.message || 'Unknown error'}<br>
              <strong>User Agent:</strong> ${navigator.userAgent}<br>
              <strong>URL:</strong> ${window.location.href}<br>
              <strong>Timestamp:</strong> ${new Date().toISOString()}
            </div>
          </details>
        </div>
      `;
    }

    // ==============================================
    // DIAGNOSTICS FUNCTION
    // ==============================================
    
    function runDiagnostics() {
      const diagnostics = {
        javascript: typeof window !== 'undefined',
        localStorage: (() => {
          try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            return true;
          } catch (e) {
            return false;
          }
        })(),
        fetch: typeof fetch !== 'undefined',
        webgl: (() => {
          try {
            const canvas = document.createElement('canvas');
            return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
          } catch (e) {
            return false;
          }
        })(),
        serviceWorker: 'serviceWorker' in navigator,
        online: navigator.onLine,
        cookiesEnabled: navigator.cookieEnabled,
        platform: navigator.platform,
        language: navigator.language
      };
      
      const results = Object.entries(diagnostics)
        .map(([key, value]) => `${key}: ${value ? '‚úÖ' : '‚ùå'}`)
        .join('\n');
      
      alert(`Browser Diagnostics:\n\n${results}\n\nIf most items show ‚ùå, try updating your browser or using a different one.`);
      
      // Track diagnostics
      if (typeof gtag !== 'undefined') {
        gtag('event', 'diagnostics_run', {
          'event_category': 'Error Handling',
          'custom_parameters': diagnostics
        });
      }
    }

    // ==============================================
    // NETWORK STATUS MONITORING
    // ==============================================
    
    window.addEventListener('online', function() {
      console.log('üåê Back online');
      const srStatus = document.getElementById('sr-status');
      if (srStatus) {
        srStatus.textContent = 'Connection restored. You can continue using the application.';
      }
    });
    
    window.addEventListener('offline', function() {
      console.log('üì° Gone offline');
      const srStatus = document.getElementById('sr-status');
      if (srStatus) {
        srStatus.textContent = 'You are currently offline. Some features may not work properly.';
      }
    });

    // ==============================================
    // KEYBOARD SHORTCUTS
    // ==============================================
    
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + R: Reload
      if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        // Let default behavior handle reload
        return;
      }
      
      // Escape: Go back to home
      if (e.key === 'Escape' && e.shiftKey) {
        if (confirm('Go back to home page?')) {
          window.location.href = 'index.html';
        }
      }
      
      // F5: Reload
      if (e.key === 'F5') {
        // Let default behavior handle reload
        return;
      }
    });

    // ==============================================
    // PERFORMANCE MONITORING
    // ==============================================
    
    // Monitor memory usage (if available)
    if ('memory' in performance) {
      setInterval(() => {
        const memory = performance.memory;
        if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.9) {
          console.warn('‚ö†Ô∏è High memory usage detected');
        }
      }, 30000); // Check every 30 seconds
    }
    
    // Monitor long tasks (if available)
    if ('PerformanceObserver' in window) {
      try {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.duration > 50) {
              console.warn('‚ö†Ô∏è Long task detected:', entry.duration + 'ms');
            }
          }
        });
        observer.observe({ entryTypes: ['longtask'] });
      } catch (e) {
        // PerformanceObserver not fully supported
      }
    }

    // ==============================================
    // ACCESSIBILITY ENHANCEMENTS
    // ==============================================
    
    // Announce loading progress to screen readers
    let loadingProgress = 0;
    const progressInterval = setInterval(() => {
      loadingProgress += 10;
      const srStatus = document.getElementById('sr-status');
      if (srStatus && loadingProgress <= 100) {
        srStatus.textContent = `Loading progress: ${loadingProgress}%`;
      }
      if (loadingProgress >= 100) {
        clearInterval(progressInterval);
      }
    }, 300);

    // ==============================================
    // BROWSER COMPATIBILITY CHECKS
    // ==============================================
    
    function checkBrowserCompatibility() {
      const issues = [];
      
      // Check for essential features
      if (!window.fetch) issues.push('Fetch API not supported');
      if (!window.Promise) issues.push('Promises not supported');
      if (!window.localStorage) issues.push('Local Storage not available');
      if (!document.querySelector) issues.push('Modern DOM methods not supported');
      
      // Check for recommended features
      if (!window.IntersectionObserver) console.warn('IntersectionObserver not supported - some animations may not work');
      if (!window.requestAnimationFrame) console.warn('RequestAnimationFrame not supported - animations may be choppy');
      
      if (issues.length > 0) {
        console.error('‚ùå Browser compatibility issues:', issues);
        return false;
      }
      
      console.log('‚úÖ Browser compatibility check passed');
      return true;
    }
    
    // Run compatibility check
    if (!checkBrowserCompatibility()) {
      setTimeout(() => {
        showErrorScreen(new Error('Your browser may not be fully compatible with this application. Please try updating your browser or using a modern browser like Chrome, Firefox, or Safari.'));
      }, 1000);
    }

    // ==============================================
    // ANALYTICS INTEGRATION
    // ==============================================
    
    // Track page view
    if (typeof gtag !== 'undefined') {
      gtag('config', 'G-BY0DNNV0K3', {
        page_title: 'Thesis Generator App',
        page_location: window.location.href
      });
    }
    
        // Track user engagement
    let engagementStartTime = Date.now();
    
    window.addEventListener('beforeunload', function() {
      const engagementTime = Date.now() - engagementStartTime;
      if (typeof gtag !== 'undefined' && engagementTime > 1000) {
        gtag('event', 'engagement_time', {
          'event_category': 'User Engagement',
          'value': Math.round(engagementTime / 1000) // in seconds
        });
      }
    });

    // ==============================================
    // SERVICE WORKER REGISTRATION
    // ==============================================
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('flutter_service_worker.js')
          .then(function(registration) {
            console.log('‚úÖ ServiceWorker registration successful');
          })
          .catch(function(err) {
            console.log('‚ö†Ô∏è ServiceWorker registration failed (this is normal for development)');
          });
      });
    }

    // ==============================================
    // PWA INSTALL PROMPT
    // ==============================================
    
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67 and earlier from automatically showing the prompt
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      
      // Show install button or banner
      console.log('üíæ PWA install prompt available');
      
      // Track the event
      if (typeof gtag !== 'undefined') {
        gtag('event', 'pwa_install_prompt_shown', {
          'event_category': 'PWA'
        });
      }
    });

    // Handle PWA install
    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('‚úÖ User accepted the PWA install prompt');
            if (typeof gtag !== 'undefined') {
              gtag('event', 'pwa_installed', {
                'event_category': 'PWA'
              });
            }
          } else {
            console.log('‚ùå User dismissed the PWA install prompt');
            if (typeof gtag !== 'undefined') {
              gtag('event', 'pwa_install_dismissed', {
                'event_category': 'PWA'
              });
            }
          }
          deferredPrompt = null;
        });
      }
    }

    // Detect if app is running as PWA
    function isPWA() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.navigator.standalone === true;
    }

    if (isPWA()) {
      console.log('üì± Running as PWA');
      if (typeof gtag !== 'undefined') {
        gtag('event', 'pwa_launched', {
          'event_category': 'PWA'
        });
      }
    }

    // ==============================================
    // DEVICE DETECTION
    // ==============================================
    
    function getDeviceInfo() {
      const ua = navigator.userAgent;
      let device = 'desktop';
      let os = 'unknown';
      
      // Detect mobile devices
      if (/Android/i.test(ua)) {
        device = 'mobile';
        os = 'android';
      } else if (/iPhone|iPad|iPod/i.test(ua)) {
        device = /iPad/i.test(ua) ? 'tablet' : 'mobile';
        os = 'ios';
      } else if (/Windows/i.test(ua)) {
        os = 'windows';
      } else if (/Mac/i.test(ua)) {
        os = 'macos';
      } else if (/Linux/i.test(ua)) {
        os = 'linux';
      }
      
      return { device, os };
    }

    const deviceInfo = getDeviceInfo();
    console.log('üì± Device info:', deviceInfo);

    // Track device info
    if (typeof gtag !== 'undefined') {
      gtag('event', 'device_info', {
        'event_category': 'Device',
        'device_type': deviceInfo.device,
        'operating_system': deviceInfo.os
      });
    }

    // ==============================================
    // INITIALIZATION COMPLETE
    // ==============================================
    
    console.log('üéì Thesis Generator app initialization complete');
    console.log('üì± Platform:', navigator.platform);
    console.log('üåê User Agent:', navigator.userAgent);
    console.log('üîó URL:', window.location.href);
    console.log('üî• Firebase Config:', firebaseConfig.projectId);
  </script>

  <!-- Structured Data for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Thesis Generator",
    "description": "AI-powered academic writing assistant for creating professional thesis content",
    "url": "https://thesis-generator-web.web.app/app.html",
    "applicationCategory": "EducationalApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "featureList": [
      "AI Chapter Generation",
      "Multiple Citation Formats",
      "Academic Writing Styles",
      "Real-time Editing",
      "Export Options"
    ],
    "author": {
      "@type": "Organization",
      "name": "Thesis Generator"
    },
    "datePublished": "2024-01-01",
    "dateModified": "2024-12-26"
  }
  </script>

  <!-- Fallback for users with JavaScript disabled -->
  <noscript>
    <div style="
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
    ">
      <div style="max-width: 500px;">
        <div style="font-size: 4rem; margin-bottom: 2rem;">üéì</div>
        <h1 style="font-size: 2rem; margin-bottom: 1rem; font-weight: 700;">JavaScript Required</h1>
        <p style="font-size: 1.2rem; margin-bottom: 2rem; line-height: 1.5; opacity: 0.9;">
          Thesis Generator requires JavaScript to function properly. Please enable JavaScript in your browser settings and refresh the page.
        </p>
        <div style="margin-bottom: 2rem;">
          <h3 style="margin-bottom: 1rem;">How to enable JavaScript:</h3>
          <div style="text-align: left; background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
            <strong>Chrome:</strong> Settings ‚Üí Privacy and Security ‚Üí Site Settings ‚Üí JavaScript ‚Üí Allowed
          </div>
          <div style="text-align: left; background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
            <strong>Firefox:</strong> about:config ‚Üí javascript.enabled ‚Üí true
          </div>
          <div style="text-align: left; background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px;">
            <strong>Safari:</strong> Preferences ‚Üí Security ‚Üí Enable JavaScript
          </div>
        </div>
        <a href="index.html" style="
          display: inline-block;
          background: linear-gradient(45deg, #9D4EDD, #FF48B0);
          color: white;
          text-decoration: none;
          padding: 1rem 2rem;
          border-radius: 8px;
          font-weight: 600;
          margin-top: 1rem;
        ">‚Üê Back to Home</a>
      </div>
    </div>
  </noscript>

  <!-- Preload critical resources -->
  <link rel="preload" href="main.dart.js" as="script">
  <link rel="preload" href="flutter.js" as="script">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.gstatic.com">
  <link rel="dns-prefetch" href="//firestore.googleapis.com">

  <!-- Meta tags for social sharing -->
  <meta property="og:title" content="Thesis Generator - AI-Powered Academic Writing">
  <meta property="og:description" content="Create professional thesis chapters with AI assistance. Supports APA, MLA, Chicago formats.">
  <meta property="og:image" content="https://thesis-generator-web.web.app/favicon.png">
  <meta property="og:url" content="https://thesis-generator-web.web.app/app.html">
  <meta property="og:type" content="website">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Thesis Generator - AI-Powered Academic Writing">
  <meta name="twitter:description" content="Create professional thesis chapters with AI assistance. Supports APA, MLA, Chicago formats.">
  <meta name="twitter:image" content="https://thesis-generator-web.web.app/favicon.png">

  <!-- Additional meta tags -->
  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow">
  <link rel="canonical" href="https://thesis-generator-web.web.app/app.html">

  <!-- Security headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- Viewport meta for better mobile experience -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Apple-specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Thesis Generator">

  <!-- Microsoft-specific meta tags -->
  <meta name="msapplication-TileColor" content="#9D4EDD">
  <meta name="msapplication-config" content="browserconfig.xml">

  <!-- Prefetch DNS for external resources -->
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  <link rel="dns-prefetch" href="//firebase.googleapis.com">
  <link rel="dns-prefetch" href="//firebaseapp.com">

  <!-- Preconnect to critical third-party origins -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

</body>
</html>

